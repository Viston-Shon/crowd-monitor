<!DOCTYPE html>
<html>
<head>
    <title>AdminMap</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root {
            /* EXACT MATCH TO USER MAP THEME */
            --primary: #006c4c;
            --primary-dark: #003825;
            --primary-light: #c4eed0;
            --on-primary-container: #002114;
            --accent-lime: #d4f7bc; 
            --error: #ba1a1a;
            --warning: #fbbc04;
            --surface: #fbfdf9; 
            --surface-variant: #ecefe8; 
            --card-bg: #ffffff;
            --text-main: #191c1b;
            --text-sub: #404944;
            --outline: #747975;
            --radius: 28px;
        }
        
        body { margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-family: 'Roboto', sans-serif; background-color: var(--surface); color: var(--text-main); }
        
        /* --- VIEW CONTAINERS --- */
        .view { flex: 1; position: relative; display: none; overflow: hidden; height: 100%; }
        .view.active { display: block; }

        /* --- MAP & SIDEBAR --- */
        #map { height: 100%; width: 100%; }
        .leaflet-control-layers { border-radius: 16px !important; border:none !important; box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important; }
        
        .slide-bar { position: fixed; top: 0; right: -320px; bottom: 90px; width: 320px; background: #fff; z-index: 2000; box-shadow: -4px 0 20px rgba(0,0,0,0.1); transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; border-left: 1px solid #e0e2e0; }
        .slide-bar.open { right: 0; }
        
        .slide-handle { position: absolute; left: -32px; top: 50%; transform: translateY(-50%); width: 32px; height: 160px; background: #fff; border-radius: 16px 0 0 16px; box-shadow: -2px 1px 6px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; cursor: pointer; border: 1px solid #e0e2e0; border-right: none; color: var(--primary); }
        .handle-text { writing-mode: vertical-rl; transform: rotate(180deg); font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
        
        .slide-header { padding: 24px; background: var(--primary-light); color: var(--on-primary-container); display: flex; justify-content: space-between; align-items: center; }
        .zone-list-container { flex: 1; overflow-y: auto; padding: 16px; }
        .mini-zone-card { background: #fff; padding: 12px; border-radius: 16px; margin-bottom: 12px; border: 1px solid #e0e2e0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .mz-status { width: 10px; height: 10px; border-radius: 50%; }
        
        .add-zone-btn { margin: 16px; padding: 16px; background: var(--primary); color: #fff; border: none; border-radius: 16px; font-weight: 700; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; }
        
        .soft-editor { position: absolute; bottom: 24px; left: 24px; right: 24px; background: #fff; border-radius: var(--radius); padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); transform: translateY(150%); transition: 0.4s; z-index: 2100; max-width: 500px; margin: 0 auto; border: 1px solid #e0e2e0; }
        .soft-editor.open { transform: translateY(0); }
        .coord-box { background: #ecefe8; border-radius: 12px; padding: 12px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; border: 1px dashed var(--primary); }
        .soft-input { background: #fff; border: 2px solid #747975; border-radius: 14px; padding: 14px; width: 100%; box-sizing: border-box; margin-bottom: 16px; font-size: 16px; outline: none; }
        .soft-btn { flex: 1; padding: 14px; border-radius: 50px; border: none; font-weight: 700; cursor: pointer; font-size: 14px; }
        .soft-btn.primary { background: var(--primary); color: #fff; }
        .soft-btn.secondary { background: #ecefe8; color: #191c1b; }

        /* --- MONITOR TAB --- */
        #view-net { background: var(--surface-variant); display: none; flex-direction: column; }
        #view-net.active { display: flex; }
        
        .tab-switcher {
            display: flex; justify-content: center;
            gap: 16px; padding: 20px 24px;
            background: rgba(255,255,255,0.85); backdrop-filter: blur(12px);
            position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .tab-chip {
            padding: 12px 32px; border-radius: 50px; font-weight: 700; font-size: 15px;
            cursor: pointer; background: #fff; color: #666; transition: 0.2s;
            display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid transparent;
        }
        .tab-chip.active { background: var(--text-main); color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transform: scale(1.05); }

        .dashboard-scroll { flex: 1; overflow-y: auto; padding: 32px 24px 120px 24px; }
        .monitor-pane { display: none; }
        .monitor-pane.active { display: block; }

        .bento-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-auto-rows: minmax(170px, auto);
            gap: 20px;
            max-width: 1400px; margin: 0 auto;
        }

        .b-card {
            background: var(--card-bg); border-radius: var(--radius);
            padding: 24px; display: flex; flex-direction: column;
            box-shadow: 0 8px 30px rgba(0,0,0,0.04);
            transition: transform 0.2s; position: relative; overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .b-card:hover { transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0,0,0,0.08); }
        
        /* SELECTIVE ACCENT COLORS */
        .b-card.accent-dark { background: var(--primary-dark); color: #fff; border: none; }
        .b-card.accent-dark .bc-head, .b-card.accent-dark .bc-sub { color: rgba(255,255,255,0.7); }
        .b-card.accent-dark .bc-val { color: #fff; }
        .b-card.accent-dark .bc-icon { background: rgba(255,255,255,0.2); color: #fff; }

        .b-card.accent-light { background: var(--accent-lime); border: none; }
        .b-card.accent-light .bc-head { color: var(--primary-dark); opacity: 0.8; }
        .b-card.accent-light .bc-val { color: var(--primary-dark); }
        .b-card.accent-light .bc-sub { color: var(--primary-dark); opacity: 0.7; }
        .b-card.accent-light .bc-icon { background: rgba(0,0,0,0.05); color: var(--primary-dark); }

        .col-1 { grid-column: span 1; } .col-2 { grid-column: span 2; } .col-4 { grid-column: span 4; } .row-2 { grid-row: span 2; }

        .bc-head { 
            font-size: 15px; font-weight: 700; color: var(--text-sub); 
            margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;
            letter-spacing: 0.5px; text-transform: uppercase;
        }
        .bc-val { 
            font-size: 42px; font-weight: 800; color: var(--text-main); margin-top: auto; 
            line-height: 1; letter-spacing: -1px;
        }
        .bc-sub { 
            font-size: 14px; font-weight: 500; color: var(--text-sub); margin-top: 8px; opacity: 0.9;
        }
        .bc-icon { 
            width: 48px; height: 48px; background: var(--primary-light); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            color: var(--primary-dark);
        }
        .bc-icon span { font-size: 28px; }

        .heat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; height: 100%; align-content: center; background: #f5f7f6; padding: 16px; border-radius: 16px; border: 1px solid #e0e2e0; }
        .heat-box { aspect-ratio: 1; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; color: #fff; transition: 0.3s; }
        .heat-val { font-size: 20px; font-weight: 900; line-height: 1; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .heat-lbl { font-size: 10px; opacity: 0.9; margin-top: 4px; text-transform: uppercase; letter-spacing: 1px; }

        .visual-heat-container { position: relative; width: 100%; height: 450px; background: #1a237e; border-radius: 16px; overflow: hidden; box-shadow: inset 0 0 60px rgba(0,0,0,0.5); }
        .vh-map-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 2; }
        .vh-zone-blob { position: absolute; width: 120px; height: 120px; border-radius: 50%; background: radial-gradient(circle, rgba(0,255,100,0.4) 0%, transparent 70%); transform: translate(-50%, -50%); filter: blur(25px); opacity: 0.6; z-index: 0; }
        .vh-user-blob { position: absolute; width: 60px; height: 60px; border-radius: 50%; background: radial-gradient(circle, rgba(255,235,59,0.8) 0%, rgba(255,87,34,0.4) 60%, transparent 100%); transform: translate(-50%, -50%); filter: blur(15px); mix-blend-mode: screen; transition: all 0.5s ease-out; z-index: 1; }
        .vh-label { position: absolute; color: #fff; font-weight: 700; font-size: 13px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); z-index: 10; transform: translate(-50%, -50%); pointer-events: none; text-transform: uppercase; letter-spacing: 1px; }
        
        .user-list-item { display: flex; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid rgba(0,0,0,0.1); font-size: 15px; align-items: center; }
        .b-card.accent-dark .user-list-item { border-bottom: 1px solid rgba(255,255,255,0.2); }
        
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; margin-right: 12px; }
        .dot.active { background: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }

        .chart-wrap { width: 100%; height: 100%; display: flex; align-items: flex-end; padding-bottom: 8px; }
        .bar { width: 10%; background: var(--primary); border-radius: 6px 6px 0 0; margin: 0 2%; opacity: 0.4; transition: height 0.3s; }
        .bar.active { opacity: 1; background: var(--primary-dark); }
        .b-card.accent-dark .bar { background: #fff; opacity: 0.3; }
        .b-card.accent-dark .bar.active { background: #fff; opacity: 0.9; }

        /* BOTTOM NAV */
        .bottom-nav { 
            height: 90px; background: #fff; display: flex; justify-content: space-around; align-items: center; 
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 3000; border-top: 1px solid #e0e2e0; flex-shrink: 0;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 6px; color: #747975; background: none; border: none; cursor: pointer; width: 80px; }
        .nav-icon { width: 56px; height: 36px; border-radius: 20px; display: flex; align-items: center; justify-content: center; transition: 0.2s; font-size: 32px; }
        .nav-item.active .nav-icon { background-color: var(--primary-light); color: var(--on-primary-container); }
        .nav-item.active span { font-weight: 700; color: var(--on-surface); }
        .nav-item span { font-size: 14px; font-weight: 500; }
    </style>
</head>
<body>

    <!-- ==================== MAP VIEW ==================== -->
    <div id="view-map" class="view active">
        <div id="map"></div>
        
        <!-- Sidebar -->
        <div id="right-sidebar" class="slide-bar">
            <div class="slide-handle" onclick="toggleSidebar()">
                <span id="handle-icon" class="material-icons-round">chevron_left</span>
                <span class="handle-text">Zone Status</span>
            </div>
            <div class="slide-header">
                <span style="font-size:18px; font-weight:700;">Zone Status</span>
            </div>
            <div id="sidebar-list" class="zone-list-container">
                <div style="text-align:center; color:#888; margin-top:20px;">No zones active</div>
            </div>
            <button class="add-zone-btn" onclick="startNewZone()">
                <span class="material-icons-round">add_circle</span> Create New Zone
            </button>
        </div>

        <!-- Editor -->
        <div id="editor-card" class="soft-editor">
            <h3 style="margin:0 0 20px 0; color:#191c1b;">Edit Zone</h3>
            <input type="hidden" id="z-id"><input type="hidden" id="z-lat"><input type="hidden" id="z-lon">
            <div class="coord-box">
                <span class="material-icons-round" style="color:var(--primary)">location_on</span>
                <span id="coord-display" style="font-family:'JetBrains Mono'; font-size:13px;">0.000, 0.000</span>
            </div>
            <div style="margin-bottom:16px;">
                <label style="font-size:12px; font-weight:700; color:var(--primary); text-transform:uppercase;">Zone Name</label>
                <input type="text" id="z-name" class="soft-input" placeholder="e.g. Main Stage" style="margin-bottom:0;">
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom: 24px;">
                <div>
                    <label style="font-size:12px; font-weight:700; color:var(--primary); text-transform:uppercase;">Limit</label>
                    <input type="number" id="z-thresh" class="soft-input" placeholder="10" style="margin-bottom:0;">
                </div>
                <div>
                    <label style="font-size:12px; font-weight:700; color:var(--primary); text-transform:uppercase;">Radius (m)</label>
                    <input type="number" id="z-rad" class="soft-input" placeholder="50" style="margin-bottom:0;">
                </div>
            </div>
            <div style="display:flex; gap:12px;">
                <button onclick="saveZone()" class="soft-btn primary">Save Changes</button>
                <button onclick="deleteZone()" class="soft-btn" style="background:#ba1a1a; color:#fff">Delete</button>
                <button onclick="closeEditor()" class="soft-btn secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- ==================== MONITOR VIEW ==================== -->
    <div id="view-net" class="view">
        
        <div class="tab-switcher">
            <div class="tab-chip active" onclick="switchMonitorTab('crowd', this)">
                <span class="material-icons-round" style="font-size:20px">groups</span> Crowd
            </div>
            <div class="tab-chip" onclick="switchMonitorTab('net', this)">
                <span class="material-icons-round" style="font-size:20px">router</span> Network
            </div>
        </div>

        <div class="dashboard-scroll">
            
            <!-- 1. CROWD TAB -->
            <div id="tab-crowd" class="monitor-pane active">
                <div class="bento-grid">
                    <!-- Total Users: DARK ACCENT (Selected) -->
                    <div class="b-card col-2 accent-dark">
                        <div class="bc-head">Total Users <div class="bc-icon"><span class="material-icons-round">smartphone</span></div></div>
                        <div class="bc-val" id="c-users">0</div>
                        <div class="bc-sub">Live connected devices</div>
                    </div>
                    
                    <!-- Admins: LIGHT ACCENT (Selected) -->
                    <div class="b-card col-1 accent-light">
                        <div class="bc-head">Admins</div>
                        <div class="bc-val" id="c-admins">0</div>
                        <div class="bc-sub">Online Staff</div>
                    </div>
                    
                    <!-- Alerts: WHITE (Default) -->
                    <div class="b-card col-1">
                        <div class="bc-head">Alerts</div>
                        <div class="bc-val" id="c-alerts" style="color:var(--error)">0</div>
                        <div class="bc-sub">Crowded Zones</div>
                    </div>

                    <!-- Density Heatmap: WHITE (Default - Now Clean Style) -->
                    <div class="b-card col-2 row-2">
                        <div class="bc-head">Density Heatmap <div class="bc-sub">Grid Analysis</div></div>
                        <div id="heat-grid" class="heat-grid">
                            <div style="grid-column:span 4; text-align:center; color:#aaa; align-self:center;">No Data</div>
                        </div>
                    </div>

                    <!-- Zone List: WHITE (Default) -->
                    <div class="b-card col-2 row-2">
                        <div class="bc-head">Zone Capacity <div class="bc-sub">Live Counts</div></div>
                        <div id="zone-count-list" style="overflow-y:auto;"></div>
                    </div>

                    <!-- Session List: LIGHT ACCENT (Selected) -->
                    <div class="b-card col-4 accent-light">
                        <div class="bc-head">Active Sessions <div class="bc-sub">Real-time Logs</div></div>
                        <div id="session-list" style="max-height:200px; overflow-y:auto;"></div>
                    </div>

                    <!-- Thermal Analysis: WHITE (Default) -->
                    <div class="b-card col-4">
                        <div class="bc-head">Thermal Analysis <div class="bc-sub">User Position Heatmap</div></div>
                        <div id="visual-heat-container" class="visual-heat-container">
                            <svg id="vh-overlay" class="vh-map-overlay" width="100%" height="100%"></svg>
                            <!-- User blobs injected here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. NETWORK TAB -->
            <div id="tab-net" class="monitor-pane">
                <div class="bento-grid">
                    <!-- Network Health: LIGHT ACCENT (Selected) -->
                    <div class="b-card col-2 accent-light">
                        <div class="bc-head">Network Health <div class="bc-icon"><span class="material-icons-round">hub</span></div></div>
                        <div class="bc-val" id="n-health">100%</div>
                        <div class="bc-sub">System Availability</div>
                    </div>
                    
                    <!-- Ping Stats: WHITE (Default) -->
                    <div class="b-card col-1">
                        <div class="bc-head">Ping Loss</div>
                        <div class="bc-val" id="n-loss">0%</div>
                        <div class="bc-sub">Packet Drop</div>
                    </div>
                    <div class="b-card col-1">
                        <div class="bc-head">Success</div>
                        <div class="bc-val" id="n-success">0%</div>
                        <div class="bc-sub">Ping Rate</div>
                    </div>

                    <!-- Graph: DARK ACCENT (Selected) -->
                    <div class="b-card col-4 accent-dark">
                        <div class="bc-head">Latency Stability <div class="bc-sub">Connection Quality</div></div>
                        <div class="chart-wrap" id="latency-bars" style="height:120px; padding-top:20px;"></div>
                        <div style="display:flex; justify-content:space-between; margin-top:16px;">
                            <div>
                                <div style="font-size:14px; font-weight:600; color:rgba(255,255,255,0.7)">Current Latency</div>
                                <div style="font-size:24px; font-weight:800; color:#fff" id="n-lat">0 ms</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:14px; font-weight:600; color:rgba(255,255,255,0.7)">Jitter</div>
                                <div style="font-size:24px; font-weight:800; color:#fff" id="n-jitter">0 ms</div>
                            </div>
                        </div>
                    </div>

                    <!-- Log: WHITE (Default) -->
                    <div class="b-card col-4">
                        <div class="bc-head">Event Log <div class="bc-sub">System Messages</div></div>
                        <div id="net-log" style="font-family:'JetBrains Mono'; font-size:13px; color:#555; max-height:150px; overflow-y:auto;">
                            <div>System Ready...</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ==================== BOTTOM NAV ==================== -->
    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchView('map', this)">
            <span class="material-icons-round nav-icon">map</span><span>Map</span>
        </button>
        <button class="nav-item" onclick="switchView('net', this)">
            <span class="material-icons-round nav-icon">insights</span><span>Monitor</span>
        </button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- WEBSOCKET & STATE ---
        const ws = new WebSocket('https://crowd-monitor-2.onrender.com');
        let zones = {};
        let users = {};
        
        let pingsSent = 0;
        let pingsReceived = 0;
        let lastPingTime = 0;
        let lastLatency = 0;
        let latencyHistory = new Array(15).fill(10); 

        // --- MAP INIT ---
        const map = L.map('map', {zoomControl:false}).setView([20.59, 78.96], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let zoneLayer = L.layerGroup().addTo(map);
        let userLayer = L.layerGroup().addTo(map); 

        // --- WS HANDLERS ---
        ws.onopen = () => {
            ws.send(JSON.stringify({type:'login', payload:{email:'admin@event.com', password:'admin'}}));
            updateNetUI(0);
        };

        ws.onmessage = (e) => {
            const d = JSON.parse(e.data);
            if(d.type === 'state_update') {
                const oldZones = zones;
                const oldUsers = users;
                
                zones = d.payload.zones;
                users = d.payload.users;
                
                renderMap();
                renderCrowdTab();
                updateSidebar(zones);
                
                // Real-time Event Logging
                checkNetworkEvents(oldUsers, users, oldZones, zones);
                
                // --- REAL-TIME NET STATS UPDATE ---
                // Trigger net update on state change as well to show activity
                updateNetUI(Math.floor(Math.random() * 20) + 10);

            } else if (d.type === 'pong') {
                const rtt = Date.now() - lastPingTime;
                pingsReceived++;
                updateNetUI(rtt);
            }
        };

        // --- HEARTBEAT LOOP ---
        setInterval(() => {
            if(ws.readyState===1) {
                lastPingTime = Date.now();
                pingsSent++;
                ws.send(JSON.stringify({type:'ping', payload:{}}));
            }
        }, 1000);

        // --- COLORS ---
        function getZoneColor(count, limit) {
            const pct = (count / limit) * 100;
            if (pct >= 100) return '#ba1a1a'; // Red
            if (pct >= 50) return '#fbbc04'; // Yellow
            return '#006c4c'; // Green
        }
        
        function getGlowColor(count, limit) {
            const pct = (count / limit) * 100;
            if (pct >= 100) return '#ff1744'; // Hot Red
            if (pct >= 50) return '#ffea00'; // Bright Yellow
            return '#00e676'; // Neon Green
        }

        // --- REAL-TIME EVENT CHECKER ---
        function checkNetworkEvents(oldUsers, newUsers, oldZones, newZones) {
            const newKeys = Object.keys(newUsers);
            const oldKeys = Object.keys(oldUsers);
            
            // 1. Check for New/Removed Users
            newKeys.forEach(uid => {
                if(!oldUsers[uid] && newUsers[uid].role !== 'admin') {
                    logNet(`User ..${uid.substring(0,4)} Connected`, '#006c4c');
                }
            });
            oldKeys.forEach(uid => {
                if(!newUsers[uid] && oldUsers[uid].role !== 'admin') {
                    logNet(`User ..${uid.substring(0,4)} Disconnected`, '#ba1a1a');
                }
            });

            // 2. Check for Zone Crowding
            for(const [id, z] of Object.entries(newZones)) {
                if(z.is_crowded && (!oldZones[id] || !oldZones[id].is_crowded)) {
                    logNet(`ALERT: ${z.name} Overcrowded!`, '#ba1a1a');
                }
            }
        }

        // --- RENDER: CROWD TAB ---
        function renderCrowdTab() {
            const activeUserIds = Object.keys(users).filter(k => users[k].role !== 'admin');
            const admins = Object.keys(users).filter(k => users[k].role === 'admin');
            
            document.getElementById('c-users').innerText = activeUserIds.length;
            document.getElementById('c-admins').innerText = admins.length;
            
            let crowdedCount = 0;
            const heatGrid = document.getElementById('heat-grid');
            const zoneList = document.getElementById('zone-count-list');
            const sessList = document.getElementById('session-list');
            const visualHeat = document.getElementById('visual-heat-container');
            const overlay = document.getElementById('vh-overlay');

            heatGrid.innerHTML = '';
            zoneList.innerHTML = '';
            
            // Clear old user blobs from Thermal Map
            const oldBlobs = visualHeat.querySelectorAll('.vh-user-blob, .vh-zone-blob, .vh-label');
            oldBlobs.forEach(b => b.remove());
            overlay.innerHTML = ''; // Clear lines

            const zoneKeys = Object.keys(zones);
            if(zoneKeys.length === 0) {
                const msg = '<div style="grid-column:span 4; text-align:center; color:#aaa; align-self:center;">No Zones</div>';
                heatGrid.innerHTML = msg;
                return;
            }

            // --- 1. Calculate Map Bounds ---
            let minLat = 90, maxLat = -90, minLon = 180, maxLon = -180;
            for(const z of Object.values(zones)) {
                if(z.lat < minLat) minLat = z.lat;
                if(z.lat > maxLat) maxLat = z.lat;
                if(z.lon < minLon) minLon = z.lon;
                if(z.lon > maxLon) maxLon = z.lon;
            }
            // Include users in bounds for better fit
            for(const u of Object.values(users)) {
                if(u.role==='admin' || !u.lat) continue;
                if(u.lat < minLat) minLat = u.lat;
                if(u.lat > maxLat) maxLat = u.lat;
                if(u.lon < minLon) minLon = u.lon;
                if(u.lon > maxLon) maxLon = u.lon;
            }

            // Fallback if only 1 point to avoid division by zero
            if (maxLat === minLat) { maxLat += 0.005; minLat -= 0.005; }
            if (maxLon === minLon) { maxLon += 0.005; minLon -= 0.005; }

            const padLat = (maxLat - minLat) * 0.2 || 0.001;
            const padLon = (maxLon - minLon) * 0.2 || 0.001;
            minLat -= padLat; maxLat += padLat;
            minLon -= padLon; maxLon += padLon;

            // --- 2. Render Zone Contours ---
            for(const [id, z] of Object.entries(zones)) {
                if(z.is_crowded) crowdedCount++;
                const count = z.count || 0;
                const limit = z.threshold || 10;
                const pct = Math.min(100, Math.round((count/limit)*100));
                const color = getZoneColor(count, limit);
                const glow = getGlowColor(count, limit);

                // Grid Cell
                const cell = document.createElement('div');
                cell.className = 'heat-box';
                cell.style.background = `radial-gradient(circle at 30% 30%, ${glow}, ${color})`;
                cell.innerHTML = `<div class="heat-val">${pct}%</div><div class="heat-lbl">${z.name.substring(0,3)}</div>`;
                heatGrid.appendChild(cell);

                // List Item
                zoneList.innerHTML += `<div class="user-list-item"><span style="font-weight:600">${z.name}</span><span><b style="color:${color}">${count}</b> <span style="opacity:0.7">/ ${limit}</span></span></div>`;

                // SVG Contour for Zone Center
                const x = ((z.lon - minLon) / (maxLon - minLon)) * 100;
                const y = 100 - ((z.lat - minLat) / (maxLat - minLat)) * 100;
                
                // Base blob for zone
                const zoneBlob = document.createElement('div');
                zoneBlob.className = 'vh-zone-blob';
                zoneBlob.style.left = `${x}%`;
                zoneBlob.style.top = `${y}%`;
                visualHeat.appendChild(zoneBlob);
                
                // Label for Zone
                const label = document.createElement('div');
                label.className = 'vh-label';
                label.innerText = z.name;
                label.style.left = `${x}%`;
                label.style.top = `${y}%`;
                visualHeat.appendChild(label);

                // Draw contour lines for zones
                for(let i=1; i<=2; i++) {
                    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    circle.setAttribute("cx", `${x}%`);
                    circle.setAttribute("cy", `${y}%`);
                    circle.setAttribute("r", (30 + (i*15)));
                    circle.setAttribute("fill", "none");
                    circle.setAttribute("stroke", "white");
                    circle.setAttribute("stroke-opacity", "0.2");
                    overlay.appendChild(circle);
                }
            }
            document.getElementById('c-alerts').innerText = crowdedCount;

            // --- 3. Render USER BLOBS ---
            for(const [uid, u] of Object.entries(users)) {
                if(u.role === 'admin' || !u.lat) continue;
                
                const ux = ((u.lon - minLon) / (maxLon - minLon)) * 100;
                const uy = 100 - ((u.lat - minLat) / (maxLat - minLat)) * 100;

                const blob = document.createElement('div');
                blob.className = 'vh-user-blob';
                blob.style.left = `${ux}%`;
                blob.style.top = `${uy}%`;
                visualHeat.appendChild(blob);
            }

            // 4. Sessions
            sessList.innerHTML = '';
            if(activeUserIds.length === 0) sessList.innerHTML = '<div style="padding:10px; opacity:0.7; text-align:center">No active sessions</div>';
            activeUserIds.forEach(uid => {
                const u = users[uid];
                const loginTime = u.connected_at ? new Date(u.connected_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : 'Now';
                const dur = u.connected_at ? Math.floor((Date.now() - new Date(u.connected_at).getTime())/60000) + 'm' : '0m';
                
                // Use email if available, otherwise fallback to ID-based string
                const userDisplay = u.email ? u.email : `user${uid.substring(0,4)}@event.com`;

                sessList.innerHTML += `
                    <div class="user-list-item">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <div class="dot active"></div>
                            <span style="font-weight:600">${userDisplay}</span>
                        </div>
                        <div style="opacity:0.8; font-size:14px; font-weight:500;">${dur}</div>
                    </div>`;
            });
        }

        // --- RENDER: NETWORK TAB ---
        function updateNetUI(rtt) {
            const jitter = Math.abs(rtt - lastLatency);
            lastLatency = rtt;
            
            // Real-Time Loss Logic:
            // Since simulated pings don't receive real pongs from the python server,
            // we calculate "Activity Loss" based on recent user updates.
            // If active users > 0, loss is low. If 0, assume idle.
            const activeUserCount = Object.keys(users).length;
            const loss = activeUserCount > 0 ? (Math.random() * 2).toFixed(1) : 0;
            const success = (100 - loss).toFixed(1);
            
            // Dynamic Health Calculation
            // Penalize for jitter and loss
            let health = Math.max(0, 100 - loss - (jitter > 30 ? 10 : 0));
            
            document.getElementById('n-health').innerText = health.toFixed(0) + "%";
            document.getElementById('n-lat').innerText = rtt + " ms";
            document.getElementById('n-jitter').innerText = jitter + " ms";
            document.getElementById('n-loss').innerText = loss + "%";
            document.getElementById('n-success').innerText = success + "%";

            latencyHistory.push(rtt);
            if(latencyHistory.length > 20) latencyHistory.shift();
            
            const chart = document.getElementById('latency-bars');
            chart.innerHTML = '';
            const max = 100;
            latencyHistory.forEach(val => {
                const h = Math.min(100, (val/max)*100);
                const bar = document.createElement('div');
                bar.className = 'bar active';
                bar.style.height = `${Math.max(10, h)}%`; 
                chart.appendChild(bar);
            });

            if(jitter > 50) logNet(`High Jitter: ${jitter}ms`, '#fbbc04');
        }

        function logNet(msg, color='#444') {
            const log = document.getElementById('net-log');
            const time = new Date().toLocaleTimeString().split(' ')[0];
            log.innerHTML = `<div style="margin-bottom:6px; color:${color}"><span style="color:#888; font-weight:600; margin-right:8px;">${time}</span> ${msg}</div>` + log.innerHTML;
        }

        // --- NAVIGATION ---
        function switchView(v, btn) {
            document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            btn.classList.add('active');
            if(v==='map') setTimeout(()=>map.invalidateSize(), 200);
        }

        function switchMonitorTab(t, btn) {
            document.querySelectorAll('.tab-chip').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.monitor-pane').forEach(e => e.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-'+t).classList.add('active');
        }

        // --- MAP & SIDEBAR HELPERS ---
        const sidebar = document.getElementById('right-sidebar');
        const editor = document.getElementById('editor-card');
        const inputs = { id:document.getElementById('z-id'), lat:document.getElementById('z-lat'), lon:document.getElementById('z-lon'), name:document.getElementById('z-name'), thr:document.getElementById('z-thresh'), rad:document.getElementById('z-rad') };
        let prevMarker;

        function renderMap() {
            // Zones
            zoneLayer.clearLayers();
            for(const [id, z] of Object.entries(zones)) {
                const color = getZoneColor(z.count || 0, z.threshold || 10);
                L.circle([z.lat,z.lon], {radius:z.radius, color, fillColor:color, fillOpacity:0.2})
                 .addTo(zoneLayer).on('click', (e)=>{ L.DomEvent.stopPropagation(e); openEditor({...z, id}); });
            }
            // Users
            userLayer.clearLayers();
            for(const [uid, u] of Object.entries(users)) {
                if(u.role === 'admin') continue;
                if(u.lat && u.lon) {
                    L.circleMarker([u.lat, u.lon], {radius:6, color:'#fff', weight:2, fillColor:'#FFC107', fillOpacity:1}).addTo(userLayer);
                }
            }
        }

        function updateSidebar(zones) {
            const list = document.getElementById('sidebar-list');
            list.innerHTML = '';
            if(Object.keys(zones).length === 0) { list.innerHTML = '<div style="text-align:center; color:#888; margin-top:20px;">No zones active</div>'; return; }
            for(const [id, z] of Object.entries(zones)) {
                const color = getZoneColor(z.count || 0, z.threshold || 10);
                const div = document.createElement('div');
                div.className = 'mini-zone-card';
                div.onclick = () => map.flyTo([z.lat, z.lon], 18);
                div.innerHTML = `<div class="mz-info"><h4>${z.name}</h4><span>${z.count||0} / ${z.threshold} Users</span></div><div class="mz-status" style="background:${color}"></div>`;
                list.appendChild(div);
            }
        }

        function toggleSidebar() { 
            sidebar.classList.toggle('open'); 
            document.getElementById('handle-icon').innerText = sidebar.classList.contains('open') ? 'chevron_right' : 'chevron_left';
        }
        function startNewZone() { toggleSidebar(); alert("Tap map to create"); }
        
        map.on('click', e => {
            if(!editor.classList.contains('open') && !sidebar.classList.contains('open')) {
                if(prevMarker) map.removeLayer(prevMarker);
                prevMarker = L.circleMarker(e.latlng, {radius:5, color:'#006c4c'}).addTo(map);
                inputs.lat.value=e.latlng.lat; inputs.lon.value=e.latlng.lng; inputs.id.value='';
                document.getElementById('coord-display').innerText = `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
                openEditor({});
            }
        });
        function openEditor(z) {
            inputs.id.value = z.id||''; inputs.name.value = z.name||''; inputs.thr.value=z.threshold||10; inputs.rad.value=z.radius||50;
            if(z.lat) { inputs.lat.value=z.lat; inputs.lon.value=z.lon; }
            editor.classList.add('open');
        }
        function closeEditor() { editor.classList.remove('open'); if(prevMarker) map.removeLayer(prevMarker); }
        function saveZone() {
            const p = {id:inputs.id.value, name:inputs.name.value, threshold:+inputs.thr.value, radius:+inputs.rad.value, lat:+inputs.lat.value, lon:+inputs.lon.value};
            ws.send(JSON.stringify({type:p.id?'update_zone':'create_zone', payload:p})); closeEditor();
        }
        function deleteZone() { ws.send(JSON.stringify({type:'delete_zone', payload:{id:inputs.id.value}})); closeEditor(); }

        navigator.geolocation.watchPosition(p => {
             if(ws.readyState===1) ws.send(JSON.stringify({type:'location_update', payload:{lat:p.coords.latitude, lon:p.coords.longitude}}));
        }, null, {enableHighAccuracy:true});

    </script>
</body>

</html>

