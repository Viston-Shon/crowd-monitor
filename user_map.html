<!DOCTYPE html>
<html>
<head>
    <title>User Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root {
            --primary: #006c4c;
            --error: #ba1a1a;
            --warning: #fbbc04;
            --surface: #fbfdf9;
            --surface-container: #ecefe8;
            --on-surface: #191c1b;
            --radius: 28px;
        }
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background: var(--surface); overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* Map takes remaining height but respects bottom sheet */
        #map { flex: 1; width: 100%; z-index: 0; margin-top: -80px; }
        
        /* Custom Left Center Control for Map Type */
        .leaflet-left { top: 50% !important; transform: translateY(-50%); }
        .leaflet-control-layers { 
            border-radius: 12px !important; border:none !important; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important; 
            font-family: 'Roboto', sans-serif; font-weight: 500;
        }

        /* --- App Bar (Header) --- */
        .app-bar {
            position: fixed; top: 16px; left: 16px; right: 16px;
            height: 64px;
            background: rgba(240, 244, 241, 0.9);
            backdrop-filter: blur(8px);
            border-radius: 32px;
            display: flex; align-items: center; padding: 0 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            z-index: 1000;
            color: var(--on-surface);
        }
        .avatar {
            width: 40px; height: 40px; background: #c4eed0; color: #002114;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; margin-right: 16px; font-size: 18px;
        }
        .app-info { flex: 1; display: flex; flex-direction: column; }
        .app-title { font-size: 16px; font-weight: 500; }
        .app-subtitle { font-size: 12px; color: #404944; }
        .status-icon { width: 12px; height: 12px; background: #ccc; border-radius: 50%; box-shadow: 0 0 0 4px #e0e4e0; transition: 0.3s;}
        .status-icon.connected { background: #006c4c; box-shadow: 0 0 0 4px #c4eed0; }

        /* --- Top Chips Legend --- */
        .chip-scroll {
            position: fixed; top: 96px; left: 0; right: 0;
            z-index: 1000; overflow-x: auto; white-space: nowrap;
            padding: 0 16px;
            -webkit-overflow-scrolling: touch;
            display: flex; gap: 8px;
            scrollbar-width: none; 
        }
        .chip-scroll::-webkit-scrollbar { display: none; }

        .chip {
            background: var(--surface); color: var(--on-surface);
            padding: 6px 16px; border-radius: 8px;
            font-size: 13px; font-weight: 500;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #c4c7c5;
            cursor: pointer; display: inline-flex; align-items: center;
            transition: 0.2s;
        }
        .chip .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }

        /* --- Bottom Sheet --- */
        .bottom-sheet {
            height: 25vh; /* Small Initial Height */
            min-height: 180px;
            background: #fff;
            border-radius: var(--radius) var(--radius) 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            z-index: 1001;
            display: flex; flex-direction: column;
            overflow: hidden;
            position: relative;
            transition: height 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .bottom-sheet.expanded {
            height: 70vh;
        }
        
        .sheet-handle-area {
            width: 100%; padding: 12px 0; cursor: pointer;
            display: flex; justify-content: center;
            background: #fff;
        }
        .sheet-handle {
            width: 40px; height: 4px; background: #e0e2e0; 
            border-radius: 2px;
        }
        .sheet-content {
            flex: 1; overflow-y: auto; padding: 0 16px 20px 16px;
        }

        /* --- Distance Cards (Horizontal Scroll) --- */
        .h-scroll-section {
            display: flex; gap: 12px; overflow-x: auto; padding-bottom: 16px;
            scrollbar-width: none; /* Firefox */
        }
        .h-scroll-section::-webkit-scrollbar { display: none; } /* Chrome */
        
        .dist-card {
            min-width: 140px; background: var(--surface-container);
            padding: 16px; border-radius: 16px;
            display: flex; flex-direction: column; justify-content: center;
            border: 1px solid #c4c7c5;
        }
        .dc-val { font-size: 24px; font-weight: 700; color: var(--primary); }
        .dc-unit { font-size: 12px; color: #404944; }
        .dc-name { font-size: 14px; font-weight: 500; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- Event Cards (Grid Layout) --- */
        .section-title { font-size: 18px; font-weight: 700; margin: 16px 0 12px 0; color: #191c1b; }
        
        #event-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); 
            gap: 12px;
            padding-bottom: 20px;
        }

        .event-card {
            display: flex; flex-direction: column; 
            background: #fff; border-radius: 16px; overflow: hidden;
            border: 1px solid #e0e2e0; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .ev-img {
            width: 100%; height: 100px; 
            background: #f0f0f0; object-fit: contain; padding: 10px; box-sizing: border-box;
        }
        .ev-body { padding: 10px; }
        .ev-time { 
            font-size: 10px; font-weight: 700; color: var(--primary); 
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; 
        }
        .ev-title { font-size: 14px; font-weight: 700; margin-bottom: 4px; color: #191c1b; line-height: 1.2;}
        .ev-venue { font-size: 11px; color: #404944; display: flex; align-items: center; gap: 4px; }

        /* --- Alerts --- */
        .alert-banner {
            position: fixed; top: 140px; left: 16px; right: 16px;
            background: #ba1a1a; color: #ffffff;
            padding: 16px; border-radius: 16px;
            display: flex; align-items: center; gap: 12px;
            box-shadow: 0 4px 12px rgba(186, 26, 26, 0.4);
            z-index: 2000;
            transform: translateY(-20px); opacity: 0; pointer-events: none;
            transition: all 0.4s cubic-bezier(0.2, 0, 0, 1);
        }
        .alert-banner.active { transform: translateY(0); opacity: 1; pointer-events: auto; }
        
        /* Popup */
        .leaflet-popup-content-wrapper { border-radius: 16px; padding: 0; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .leaflet-popup-content { margin: 0; width: 200px !important; }
        .pop-header { padding: 12px 16px; background: #f0f4f1; font-weight: 700; font-size: 15px; color: #191c1b; border-bottom: 1px solid #e0e2e0; }
        .pop-body { padding: 16px; }
        .pop-stat { font-size: 12px; color: #404944; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .pop-val { font-weight: 500; color: #191c1b; }
        .progress-bg { height: 6px; background: #e0e2e0; border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s; background: var(--primary); }
        .status-badge { display: inline-block; font-size: 11px; padding: 2px 8px; border-radius: 4px; margin-top: 10px; font-weight: 500; background: #c4eed0; color: #002114; }

    </style>
</head>
<body>

    <div class="app-bar">
        <div class="avatar">U</div>
        <div class="app-info">
            <div class="app-title">Event Map</div>
            <div class="app-subtitle">Live Crowd Monitor</div>
        </div>
        <div id="conn-dot" class="status-icon"></div>
    </div>

    <div id="chip-container" class="chip-scroll"></div>

    <div id="map"></div>
    
    <!-- BOTTOM SHEET -->
    <div id="bottom-sheet" class="bottom-sheet">
        <div class="sheet-handle-area" onclick="toggleSheet()">
            <div class="sheet-handle"></div>
        </div>
        <div class="sheet-content">
            
            <div class="section-title" style="margin-top:0">Nearby Zones</div>
            <div id="distance-cards" class="h-scroll-section">
                <div style="padding:20px; color:#999; font-size:13px;">Waiting for location...</div>
            </div>

            <div class="section-title">Upcoming Events</div>
            <div id="event-list"></div>
        </div>
    </div>
    
    <div id="alert" class="alert-banner">
        <span class="material-icons-round">warning</span>
        <div id="alert-msg" style="flex:1; font-weight:500; font-size:14px;">Zone Alert</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize Map with Default Zoom 18 (High Zoom)
        const map = L.map('map', {zoomControl: false}).setView([20.5937, 78.9629], 18);
        
        // Layers
        const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
        const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
        streetLayer.addTo(map);

        // Left Center Control
        L.control.layers({
            "Street": streetLayer,
            "Satellite": satLayer
        }, null, {position: 'topleft'}).addTo(map);

        let myMarker, zonesLayers = {}, crowdedState = {};
        let currentLat = 0, currentLon = 0;
        let zonesData = {}; 

        const ws = new WebSocket('https://crowd-monitor-2.onrender.com');
        const alertBox = document.getElementById('alert');
        const chipContainer = document.getElementById('chip-container');
        const connDot = document.getElementById('conn-dot');

        const eventImages = [
            "https://cdn-icons-png.flaticon.com/512/1999/1999310.png", 
            "https://cdn-icons-png.flaticon.com/512/2830/2830305.png", 
            "https://cdn-icons-png.flaticon.com/512/2454/2454273.png"
        ];

        function toggleSheet() {
            document.getElementById('bottom-sheet').classList.toggle('expanded');
        }

        function showAlert(msg) {
            document.getElementById('alert-msg').innerHTML = msg;
            alertBox.classList.add('active');
            setTimeout(() => alertBox.classList.remove('active'), 5000);
        }

        ws.onopen = () => {
            connDot.classList.add('connected');
            ws.send(JSON.stringify({type:'login', payload:{email:'user',password:'user'}}));
        };
        ws.onclose = () => connDot.classList.remove('connected');

        ws.onmessage = (e) => {
            const d = JSON.parse(e.data);
            if(d.type === 'state_update') {
                zonesData = d.payload.zones;
                updateMap(zonesData);
                updateBottomUI();
            }
        };

        function getZoneColor(count, limit) {
            const pct = (count / limit) * 100;
            if (pct >= 100) return '#ba1a1a'; // Red
            if (pct >= 50) return '#fbbc04'; // Yellow
            return '#006c4c'; // Green
        }

        function updateMap(zData) {
            Object.values(zonesLayers).forEach(l => map.removeLayer(l));
            zonesLayers = {};
            chipContainer.innerHTML = '';

            for(const id in zData) {
                const z = zData[id];
                const isCrowded = z.is_crowded;
                const count = z.count || 0;
                const limit = z.threshold || 10;
                const pct = Math.min(100, Math.round((count / limit) * 100));
                
                const color = getZoneColor(count, limit);

                const popupHTML = `
                    <div class="pop-header">${z.name}</div>
                    <div class="pop-body">
                        <div class="pop-stat"><span>Capacity</span> <span class="pop-val">${pct}%</span></div>
                        <div class="progress-bg">
                            <div class="progress-fill" style="width:${pct}%; background:${color}"></div>
                        </div>
                        <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-size:12px; color:#404944;">${count} / ${limit} devices</span>
                            <span class="status-badge" style="background:${color}20; color:${color}">${isCrowded ? 'CROWDED' : (pct>=50?'BUSY':'NORMAL')}</span>
                        </div>
                    </div>
                `;

                const circle = L.circle([z.lat,z.lon], {color, fillColor:color, fillOpacity:0.3, radius:z.radius}).addTo(map);
                circle.bindPopup(popupHTML);
                zonesLayers[id] = circle;

                const chip = document.createElement('div');
                chip.className = `chip`;
                chip.innerHTML = `<div class="dot" style="background:${color}"></div>${z.name}`;
                chip.onclick = () => {
                    map.flyTo([z.lat, z.lon], 18, {duration: 1.0});
                    setTimeout(() => circle.openPopup(), 1100);
                };
                chipContainer.appendChild(chip);

                if(isCrowded && !crowdedState[id]) showAlert(`Alert: <b>${z.name}</b> is overcrowded!`);
                crowdedState[id] = isCrowded;
            }
        }

        function updateBottomUI() {
            if(!currentLat || !currentLon) return;

            const distContainer = document.getElementById('distance-cards');
            const eventContainer = document.getElementById('event-list');
            
            distContainer.innerHTML = '';
            eventContainer.innerHTML = '';

            let i = 0;
            for(const id in zonesData) {
                const z = zonesData[id];
                
                const dist = map.distance([currentLat, currentLon], [z.lat, z.lon]);
                let distStr;
                let unitStr = "Distance";
                let valColor = "var(--primary)";

                if (dist <= z.radius) {
                    distStr = "0m";
                    unitStr = "Inside Zone";
                    valColor = "#fbbc04"; 
                } else {
                    distStr = dist > 1000 ? (dist/1000).toFixed(1) + ' km' : Math.round(dist) + ' m';
                }

                const dCard = document.createElement('div');
                dCard.className = 'dist-card';
                dCard.innerHTML = `
                    <div class="dc-val" style="color:${valColor}">${distStr}</div>
                    <div class="dc-unit">${unitStr}</div>
                    <div class="dc-name">${z.name}</div>
                `;
                distContainer.appendChild(dCard);

                const eImg = eventImages[i % eventImages.length];
                const time = new Date(); 
                time.setHours(time.getHours() + i + 1);
                const timeStr = time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                const eCard = document.createElement('div');
                eCard.className = 'event-card';
                eCard.innerHTML = `
                    <img src="${eImg}" class="ev-img">
                    <div class="ev-body">
                        <div class="ev-time">Today, ${timeStr}</div>
                        <div class="ev-title">Live @ ${z.name}</div>
                        <div class="ev-venue">
                            <span class="material-icons-round" style="font-size:16px;">location_on</span>
                            ${z.name}
                        </div>
                    </div>
                `;
                eventContainer.appendChild(eCard);
                i++;
            }
        }

        navigator.geolocation.watchPosition(p => {
            const {latitude:lat, longitude:lon} = p.coords;
            currentLat = lat;
            currentLon = lon;

            if(!myMarker) {
                myMarker = L.circleMarker([lat,lon], {radius:8, color:'white', weight:3, fillColor:'#4285F4', fillOpacity:1}).addTo(map);
                map.setView([lat,lon], 18);
            } else myMarker.setLatLng([lat,lon]);
            
            if(ws.readyState===1) ws.send(JSON.stringify({type:'location_update', payload:{lat,lon}}));
            
            updateBottomUI();

        }, null, {enableHighAccuracy:true});
    </script>
</body>

</html>
